<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cover Night Voting</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    body { margin:0; font-family:system-ui; background:#0f0f0f; color:#fff; display:flex; justify-content:center; padding:20px; }
    .container { width:100%; max-width:420px; }
    h1 { text-align:center; }
    .card { background:#1c1c1c; border-radius:16px; padding:16px; margin-bottom:12px; display:flex; gap:12px; align-items:center; }
    img { width:64px; height:64px; border-radius:12px; object-fit:cover; }
    button { background:#fff; color:#000; border:none; border-radius:12px; padding:8px 12px; font-weight:600; cursor:pointer; }
    input { width:100%; margin-bottom:8px; padding:10px; border-radius:10px; border:none; }
    .admin { background:#151515; padding:16px; border-radius:16px; margin-bottom:20px; }
    .hidden { display:none; }
    .winner { text-align:center; background:#151515; padding:20px; border-radius:20px; }
  </style>
</head>
<body>
<div class="container">
  <h1>üé§ Cover Night</h1>

  <!-- ADMIN -->
  <div class="admin" id="admin">
    <h3>Admin</h3>
    <input id="artistInput" placeholder="Nome cantante" />
    <input id="songInput" placeholder="Nome canzone" />
    <input id="photoUrlInput" placeholder="URL immagine" />
    <button id="addBtn">Aggiungi cover</button>
    <hr style="margin:12px 0">
    <button id="addExtraVoteBtn">Aggiungi secondo voto a tutti</button>
    <button id="closeBtn">CHIUDI VOTAZIONI</button>
  </div>

  <!-- VOTI -->
  <div id="points"></div>
  <div id="list"></div>

  <!-- WINNER -->
  <div id="winner" class="winner hidden"></div>
</div>

<script>
  // üî• FIREBASE CONFIG
const firebaseConfig = {
  apiKey: "AIzaSyC5E-yc4KskjoAsNqArf31l7CLu8K4vXYc",
  authDomain: "covernight-20b1c.firebaseapp.com",
  projectId: "covernight-20b1c",
  storageBucket: "covernight-20b1c.firebasestorage.app",
  messagingSenderId: "624721857728",
  appId: "1:624721857728:web:ca1b2fc21c351c4cb6f125",
  measurementId: "G-T45NH307EB"
};
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // üîê ADMIN ACCESS
  const ADMIN_PASSWORD = "cover2025";
  const adminParam = new URLSearchParams(window.location.search).get("admin");
  if (adminParam !== ADMIN_PASSWORD) {
    document.getElementById("admin").style.display = "none";
  }

  // üë§ USER POINTS (inizialmente 1 voto)
  let points = Number(localStorage.getItem("points") ?? 1);
  const pointsEl = document.getElementById("points");

  function updatePoints() {
    pointsEl.innerHTML = `<p>Punti disponibili: <strong>${points}</strong></p>`;
    localStorage.setItem("points", points);
  }
  updatePoints();

  // ‚ûï ADD COVER (IMMAGINE DA URL)
  document.getElementById("addBtn").addEventListener("click", async () => {
    const artist = document.getElementById("artistInput").value.trim();
    const song = document.getElementById("songInput").value.trim();
    const photoUrl = document.getElementById("photoUrlInput").value.trim();

    if (!artist || !song || !photoUrl) {
      alert("Compila tutti i campi");
      return;
    }

    await db.collection("covers").add({
      artist,
      song,
      photo: photoUrl,
      votes: 0,
    });

    document.getElementById("artistInput").value = "";
    document.getElementById("songInput").value = "";
    document.getElementById("photoUrlInput").value = "";
  });

  // üó≥Ô∏è VOTE
  window.vote = async (id) => {
    if (points <= 0) {
      alert("Hai finito i punti");
      return;
    }

    const docRef = db.collection("covers").doc(id);

    await db.runTransaction(async (t) => {
      const d = await t.get(docRef);
      if (!d.exists) return;
      t.update(docRef, { votes: d.data().votes + 1 });
    });

    points--;
    updatePoints();
  };

  // ‚ûï AGGIUNGI SECONDO VOTO A TUTTI
  document.getElementById("addExtraVoteBtn").addEventListener("click", async () => {
    const snap = await db.collection("covers").get();
    snap.forEach(async (doc) => {
      await db.collection("covers").doc(doc.id).update({ votes: doc.data().votes + 1 });
    });
    // Aggiorna punti utenti solo se vuoi darli di nuovo
    points = 1;
    updatePoints();
    alert("Tutti hanno ricevuto un secondo voto!");
  });

  // ‚õî CHIUSURA VOTAZIONI
  document.getElementById("closeBtn").addEventListener("click", () => {
    db.collection("config").doc("state").set({ closed: true });
  });

  // üîî LISTENERS
  db.collection("config").doc("state").onSnapshot((doc) => {
    if (doc.exists && doc.data().closed) {
      showWinner();
    }
  });

  db.collection("covers").onSnapshot((snap) => {
    const list = document.getElementById("list");
    list.innerHTML = "";

    snap.forEach((d) => {
      const c = d.data();
      list.innerHTML += `
        <div class="card">
          <img src="${c.photo}" alt="${c.artist}">
          <div style="flex:1">
            <strong>${c.artist}</strong><br>
            <small>${c.song}</small><br>
            <small>Voti: ${c.votes}</small>
          </div>
          <button onclick="vote('${d.id}')">Vota</button>
        </div>`;
    });
  });

  // üèÜ WINNER SCREEN
  async function showWinner() {
    document.getElementById("list").classList.add("hidden");
    pointsEl.classList.add("hidden");

    const snap = await db.collection("covers").orderBy("votes", "desc").get();
    if (snap.empty) return;

    const winner = snap.docs[0].data();

    const winnerEl = document.getElementById("winner");
    winnerEl.innerHTML = `
      <h2>üèÜ Vincitore</h2>
      <img src="${winner.photo}" style="width:120px;height:120px;border-radius:20px"><br><br>
      <strong>${winner.artist}</strong><br>
      <small>${winner.song}</small><br><br>
      <p>Voti: ${winner.votes}</p>`;

    winnerEl.classList.remove("hidden");
  }
</script>
</body>
</html>
