<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cover Night Voting</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    body { margin:0; font-family:system-ui; background:#0f0f0f; color:#fff; display:flex; justify-content:center; padding:20px; }
    .container { width:100%; max-width:420px; }
    h1 { text-align:center; }
    .card { background:#1c1c1c; border-radius:16px; padding:16px; margin-bottom:12px; display:flex; gap:12px; align-items:center; }
    img { width:64px; height:64px; border-radius:12px; object-fit:cover; }
    button { background:#fff; color:#000; border:none; border-radius:12px; padding:8px 12px; font-weight:600; cursor:pointer; }
    input { width:100%; margin-bottom:8px; padding:10px; border-radius:10px; border:none; }
    .admin { background:#151515; padding:16px; border-radius:16px; margin-bottom:20px; }
    .hidden { display:none; }
    .winner { text-align:center; background:#151515; padding:20px; border-radius:20px; }
  </style>
</head>
<body>
<div class="container">
  <h1>ðŸŽ¤ Cover Night</h1>

  <div class="admin" id="admin">
    <h3>Admin</h3>
    <input id="artistInput" placeholder="Nome cantante" />
    <input id="songInput" placeholder="Nome canzone" />
    <input id="photoUrlInput" placeholder="URL immagine" />
    <button id="addBtn">Aggiungi cover</button>
    <hr style="margin:12px 0">
    <button id="addVoteBtn">âž• Aggiungi voto</button>
    <button id="removeVoteBtn">âž– Togli voto</button>
    <button id="closeBtn">Chiudi votazioni</button>
  </div>

  <div id="points"></div>
  <div id="list"></div>
  <div id="winner" class="winner hidden"></div>
</div>

<script>
// ================= FIREBASE =================
const firebaseConfig = {
  apiKey: "AIzaSyC5E-yc4KskjoAsNqArf31l7CLuK4vXYc",
  authDomain: "covernight-20b1c.firebaseapp.com",
  projectId: "covernight-20b1c",
  storageBucket: "covernight-20b1c.firebasestorage.app",
  messagingSenderId: "624721857728",
  appId: "1:624721857728:web:ca1b2fc21c351c4cb6f125"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ================= ADMIN ================= */
const ADMIN_PASSWORD = "2025";
const adminParam = new URLSearchParams(window.location.search).get("admin");
const isAdmin = adminParam === ADMIN_PASSWORD;
if (!isAdmin) document.getElementById("admin").style.display = "none";

/* ================= USER ================= */
let userId = localStorage.getItem("userId");
if (!userId) {
  userId = crypto.randomUUID();
  localStorage.setItem("userId", userId);
}

const userRef = db.collection("users").doc(userId);
const votesConfigRef = db.collection("config").doc("votes");

/* crea utente solo se non esiste */
userRef.get().then(doc => {
  if (!doc.exists) userRef.set({ votesUsed: 0 });
});

/* crea config voti se non esiste */
votesConfigRef.get().then(doc => {
  if (!doc.exists) votesConfigRef.set({ totalVotes: 1 });
});

/* ================= UI ================= */
let totalVotes = 0;
let votesUsed = 0;

function updateUI() {
  const available = Math.max(totalVotes - votesUsed, 0);
  document.getElementById("points").innerHTML =
    `<p>Voti disponibili: <strong>${available}</strong></p>`;
}

/* ================= LISTENERS ================= */
votesConfigRef.onSnapshot(doc => {
  if (!doc.exists) return;
  totalVotes = doc.data().totalVotes;
  updateUI();
});

userRef.onSnapshot(doc => {
  if (!doc.exists) return;
  votesUsed = doc.data().votesUsed;
  updateUI();
});

/* ================= VOTE ================= */
window.vote = async (coverId) => {
  const coverRef = db.collection("covers").doc(coverId);

  await db.runTransaction(async t => {
    const [userDoc, votesDoc, coverDoc] = await Promise.all([
      t.get(userRef),
      t.get(votesConfigRef),
      t.get(coverRef)
    ]);

    const used = userDoc.data().votesUsed;
    const total = votesDoc.data().totalVotes;

    if (used >= total) throw "NO_VOTES";

    t.update(userRef, { votesUsed: used + 1 });
    t.update(coverRef, { votes: coverDoc.data().votes + 1 });
  }).catch(() => alert("Hai finito i voti"));
};

/* ================= ADMIN ACTIONS ================= */
document.getElementById("unlockSecondVoteBtn").onclick = async () => {
  await votesConfigRef.update({
    totalVotes: firebase.firestore.FieldValue.increment(1)
  });
};

window.removeVote = async () => {
  await votesConfigRef.update({
    totalVotes: firebase.firestore.FieldValue.increment(-1)
  });
};

/* ================= COVERS ================= */
db.collection("covers").onSnapshot(snap => {
  const list = document.getElementById("list");
  list.innerHTML = "";

  snap.forEach(d => {
    const c = d.data();
    if (c.hidden && !isAdmin) return;

    list.innerHTML += `
      <div class="card">
        <img src="${c.photo}">
        <div style="flex:1">
          <strong>${c.artist}</strong><br>
          <small>${c.song}</small><br>
          <small>Voti: ${c.votes}</small>
        </div>
        ${
          isAdmin
            ? `<button onclick="toggleCover('${d.id}')">${c.hidden ? 'Mostra' : 'Nascondi'}</button>`
            : `<button onclick="vote('${d.id}')">Vota</button>`
        }
      </div>
    `;
  });
});

/* ================= TOGGLE COVER ================= */
window.toggleCover = async (id) => {
  const ref = db.collection("covers").doc(id);
  const doc = await ref.get();
  ref.update({ hidden: !doc.data().hidden });
};
</script>

</body>
</html>
