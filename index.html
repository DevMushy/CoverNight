<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cover Night Voting</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    body {
      margin: 0;
      font-family: system-ui;
      background: #0f0f0f;
      color: #fff;
      display: flex;
      justify-content: center;
      padding: 20px;
    }

    .container {
      width: 100%;
      max-width: 420px;
    }

    h1 {
      text-align: center;
    }

    .card {
      background: #1c1c1c;
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 12px;
      display: flex;
      gap: 12px;
      align-items: center;
    }

    img {
      width: 64px;
      height: 64px;
      border-radius: 12px;
      object-fit: cover;
    }

    button {
      background: #fff;
      color: #000;
      border: none;
      border-radius: 12px;
      padding: 8px 12px;
      font-weight: 600;
      cursor: pointer;
    }

    input {
      width: 100%;
      margin-bottom: 8px;
      padding: 10px;
      border-radius: 10px;
      border: none;
    }

    .admin {
      background: #151515;
      padding: 16px;
      border-radius: 16px;
      margin-bottom: 20px;
    }

    .hidden {
      display: none;
    }

    .winner {
      text-align: center;
      background: #151515;
      padding: 20px;
      border-radius: 20px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>üé§ Cover Night</h1>

    <!-- ADMIN -->
    <div class="admin" id="admin">
      <h3>Admin</h3>
      <input id="artistInput" placeholder="Nome cantante" />
      <input id="songInput" placeholder="Nome canzone" />
      <input id="photoUrlInput" placeholder="URL immagine" />
      <button id="addBtn">Aggiungi cover</button>
      <hr style="margin:12px 0">
      <button id="unlockSecondVoteBtn">AGGIUNGI VOTO</button>
      <button id="removeVoteBtn">TOGLI VOTO</button>
      <button id="closeBtn">CHIUDI VOTAZIONI</button>
    </div>

    <div id="points"></div>
    <div id="list"></div>
    <div id="winner" class="winner hidden"></div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC5E-yc4KskjoAsNqArf31l7CLuK4vXYc",
      authDomain: "covernight-20b1c.firebaseapp.com",
      projectId: "covernight-20b1c",
      storageBucket: "covernight-20b1c.firebasestorage.app",
      messagingSenderId: "624721857728",
      appId: "1:624721857728:web:ca1b2fc21c351c4cb6f125",
      measurementId: "G-T45NH307EB"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const ADMIN_PASSWORD = "2025";
    const adminParam = new URLSearchParams(window.location.search).get("admin");
    const adminPanel = document.getElementById("admin");
    const pointsEl = document.getElementById("points");

    if (adminParam !== ADMIN_PASSWORD) adminPanel.style.display = "none";

    // USER
    let userId = localStorage.getItem("userId");
    if (!userId) {
      userId = crypto.randomUUID();
      localStorage.setItem("userId", userId);
    }
    const userRef = db.collection("users").doc(userId);

    // CREA UTENTE SOLO SE NON ESISTE
    userRef.get().then(doc => {
      if (!doc.exists) {
        userRef.set({ votesUsed: 0, allowedVotes: 1 });
      }
    });

    let availableVotes = 0;

    // Aggiorna voti disponibili
    userRef.onSnapshot(doc => {
      if (!doc.exists) return;
      const data = doc.data();
      availableVotes = data.allowedVotes - data.votesUsed;
      pointsEl.innerHTML = `<p>Voti disponibili: <strong>${availableVotes}</strong></p>`;
    });

    // ADD COVER
    document.getElementById("addBtn").onclick = async () => {
      const artist = artistInput.value.trim();
      const song = songInput.value.trim();
      const photo = photoUrlInput.value.trim();
      if (!artist || !song || !photo) return alert("Compila tutto");
      await db.collection("covers").add({ artist, song, photo, votes: 0, hidden: false });
      artistInput.value = songInput.value = photoUrlInput.value = "";
    };

    // VOTE
    window.vote = async (id) => {
      const coverRef = db.collection("covers").doc(id);

      await db.runTransaction(async t => {
        const userDoc = await t.get(userRef);
        if (!userDoc.exists) return;
        const { votesUsed, allowedVotes } = userDoc.data();
        if (votesUsed >= allowedVotes) throw "NO_VOTES";

        const coverDoc = await t.get(coverRef);
        t.update(coverRef, { votes: coverDoc.data().votes + 1 });
        t.update(userRef, { votesUsed: votesUsed + 1 });
      }).catch(() => alert("Hai finito i voti"));
    };

    // HIDE/SHOW COVER
    function toggleCover(id) {
      const ref = db.collection("covers").doc(id);
      ref.get().then(doc => {
        if (!doc.exists) return;
        ref.update({ hidden: !doc.data().hidden });
      });
    }

    // REMOVE VOTE (solo utenti che non hanno votato)
    async function removeVote() {
      const usersSnap = await db.collection("users").get();
      usersSnap.forEach(u => {
        const data = u.data();
        if (data.votesUsed < data.allowedVotes) {
          u.ref.update({ allowedVotes: data.allowedVotes - 1 });
        }
      });
      alert("Tolto 1 voto agli utenti che non avevano ancora votato");
    }

    // ADD VOTE (admin)
    document.getElementById("unlockSecondVoteBtn").onclick = async () => {
      const usersSnap = await db.collection("users").get();
      usersSnap.forEach(u => {
        const data = u.data();
        u.ref.update({ allowedVotes: data.allowedVotes + 1 });
      });
      alert("Voto aggiunto a tutti!");
    };

    // REMOVE VOTE BUTTON
    document.getElementById("removeVoteBtn").onclick = removeVote;

    // DISPLAY COVERS
    db.collection("covers").onSnapshot(snap => {
      const list = document.getElementById("list");
      list.innerHTML = "";
      snap.forEach(d => {
        const c = d.data();
        if (c.hidden && adminParam !== ADMIN_PASSWORD) return; // utenti non admin non vedono nascoste

        let buttons = adminParam === ADMIN_PASSWORD
          ? `<button onclick="toggleCover('${d.id}')">${c.hidden ? 'Mostra' : 'Nascondi'}</button>`
          : `<button onclick="vote('${d.id}')">Vota</button>`;

        list.innerHTML += `
        <div class="card">
          <img src="${c.photo}">
          <div style="flex:1">
            <strong>${c.artist}</strong><br>
            <small>${c.song}</small><br>
            <small>Voti: ${c.votes}</small>
          </div>
          ${buttons}
        </div>`;
      });
    });

    // MOSTRA IL VINCITORE
db.collection("config").doc("state").onSnapshot(async doc => {
  if (!doc.exists || !doc.data().closed) return;

  const listEl = document.getElementById("list");
  listEl.classList.add("hidden");
  pointsEl.classList.add("hidden");

  const winnerEl = document.getElementById("winner");
  const snap = await db.collection("covers").orderBy("votes", "desc").limit(1).get();
  if (snap.empty) return;

  const w = snap.docs[0].data();

  winnerEl.innerHTML = `
    <h2>üèÜ Vincitore</h2>
    <img src="${w.photo}" style="width:120px; border-radius:20px"><br><br>
    <strong>${w.artist}</strong><br>
    <small>${w.song}</small><br><br>
    <p>Voti: ${w.votes}</p>
  `;
  winnerEl.classList.remove("hidden");
});


  </script>
</body>

</html>

