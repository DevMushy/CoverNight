<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cover Night Voting</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    body { margin:0; font-family:system-ui; background:#0f0f0f; color:#fff; display:flex; justify-content:center; padding:20px; }
    .container { width:100%; max-width:420px; }
    h1 { text-align:center; }
    .card { background:#1c1c1c; border-radius:16px; padding:16px; margin-bottom:12px; display:flex; gap:12px; align-items:center; }
    img { width:64px; height:64px; border-radius:12px; object-fit:cover; }
    button { background:#fff; color:#000; border:none; border-radius:12px; padding:8px 12px; font-weight:600; cursor:pointer; }
    input { width:100%; margin-bottom:8px; padding:10px; border-radius:10px; border:none; }
    .admin { background:#151515; padding:16px; border-radius:16px; margin-bottom:20px; }
    .hidden { display:none; }
    .winner { text-align:center; background:#151515; padding:20px; border-radius:20px; }
  </style>
</head>
<body>

<div class="container">
  <h1>üé§ Cover Night</h1>

  <!-- ADMIN -->
  <div class="admin" id="admin">
    <h3>Admin</h3>
    <input id="artistInput" placeholder="Nome cantante">
    <input id="songInput" placeholder="Nome canzone">
    <input id="photoInput" placeholder="URL immagine">
    <button id="addCoverBtn">Aggiungi cover</button>
    <hr>
    <button id="addVoteBtn">AGGIUNGI SECONDO VOTO</button>
    <button id="closeVotingBtn">CHIUDI VOTAZIONI</button>
  </div>

  <div id="points"></div>
  <div id="list"></div>
  <div id="winner" class="winner hidden"></div>
</div>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey: "AIzaSyC5E-yc4KskjoAsNqArf31l7CLu8K4vXYc",
  authDomain: "covernight-20b1c.firebaseapp.com",
  projectId: "covernight-20b1c",
  storageBucket: "covernight-20b1c.firebasestorage.app",
  messagingSenderId: "624721857728",
  appId: "1:624721857728:web:ca1b2fc21c351c4cb6f125"
});
const db = firebase.firestore();

/* ================= ADMIN ================= */
const ADMIN_PASSWORD = "cover2025";
if (new URLSearchParams(location.search).get("admin") !== ADMIN_PASSWORD) {
  document.getElementById("admin").remove();
}

/* ================= USER ================= */
let userId = localStorage.getItem("userId");
if (!userId) {
  userId = crypto.randomUUID();
  localStorage.setItem("userId", userId);
}

// crea utente SOLO se non esiste
const userRef = db.collection("users").doc(userId);
userRef.get().then(doc => {
  if (!doc.exists) {
    userRef.set({
      votesUsed: 0,
      allowedVotes: 1
    });
  }
});

/* ================= GLOBAL VOTES CONFIG ================= */
db.collection("config").doc("votes").get().then(doc => {
  if (!doc.exists) {
    db.collection("config").doc("votes").set({ allowedVotes: 1 });
  }
});

// sync allowedVotes globali
db.collection("config").doc("votes").onSnapshot(doc => {
  if (!doc.exists) return;
  userRef.update({ allowedVotes: doc.data().allowedVotes });
});

/* ================= UI POINTS ================= */
const pointsEl = document.getElementById("points");

userRef.onSnapshot(doc => {
  if (!doc.exists) return;
  const { allowedVotes, votesUsed } = doc.data();
  pointsEl.innerHTML = `<p>Voti disponibili: <strong>${allowedVotes - votesUsed}</strong></p>`;
});

/* ================= ADD COVER ================= */
document.getElementById("addCoverBtn").onclick = async () => {
  const artist = artistInput.value.trim();
  const song = songInput.value.trim();
  const photo = photoInput.value.trim();
  if (!artist || !song || !photo) return alert("Compila tutto");

  await db.collection("covers").add({
    artist,
    song,
    photo,
    votes: 0
  });

  artistInput.value = songInput.value = photoInput.value = "";
};

/* ================= VOTE ================= */
window.vote = async (coverId) => {
  const coverRef = db.collection("covers").doc(coverId);

  try {
    await db.runTransaction(async t => {
      const userDoc = await t.get(userRef);
      const coverDoc = await t.get(coverRef);

      if (!userDoc.exists || !coverDoc.exists) return;

      const { votesUsed, allowedVotes } = userDoc.data();
      if (votesUsed >= allowedVotes) throw "NO_VOTES";

      t.update(userRef, { votesUsed: votesUsed + 1 });
      t.update(coverRef, { votes: coverDoc.data().votes + 1 });
    });
  } catch {
    alert("Hai finito i voti");
  }
};

/* ================= LIST ================= */
db.collection("covers").onSnapshot(snap => {
  list.innerHTML = "";
  snap.forEach(doc => {
    const c = doc.data();
    list.innerHTML += `
      <div class="card">
        <img src="${c.photo}">
        <div style="flex:1">
          <strong>${c.artist}</strong><br>
          <small>${c.song}</small><br>
          <small>Voti: ${c.votes}</small>
        </div>
        <button onclick="vote('${doc.id}')">Vota</button>
      </div>
    `;
  });
});

/* ================= ADD SECOND VOTE ================= */
document.getElementById("addVoteBtn").onclick = async () => {
  await db.collection("config").doc("votes").set({ allowedVotes: 2 });
  alert("Secondo voto sbloccato!");
};

/* ================= CLOSE + WINNER ================= */
document.getElementById("closeVotingBtn").onclick = async () => {
  await db.collection("config").doc("state").set({ closed: true });
};

db.collection("config").doc("state").onSnapshot(async doc => {
  if (!doc.exists || !doc.data().closed) return;

  list.classList.add("hidden");
  pointsEl.classList.add("hidden");

  const snap = await db.collection("covers").orderBy("votes", "desc").get();
  const w = snap.docs[0].data();

  winner.innerHTML = `
    <h2>üèÜ Vincitore</h2>
    <img src="${w.photo}" style="width:120px;border-radius:20px"><br><br>
    <strong>${w.artist}</strong><br>
    <small>${w.song}</small><br><br>
    <p>Voti: ${w.votes}</p>
  `;
  winner.classList.remove("hidden");
});
</script>
</body>
</html>
